# 浏览器缓存

浏览器缓存分为HTTP缓存和非HTTP缓存，而HTTP缓存又分为协商缓存和强缓存，二者是前端面试常考点。

**HTTP缓存**：

只要资源是通过HTTP(S)请求得来的并且服务器返回了缓存相关的响应头，浏览器就会自动缓存，称之为HTTP缓存。

缓存相关的响应头典型有：

- Cache-Control
- Expires
- ETag
- Last-Modified
- Vary

适用场景：JS、CSS、图片、字体等静态资源。

**非HTTP缓存：**

缓存数据但不通过HTTP缓存机制，而是靠开发者或系统层面。

例如前端本地数据缓存：`localStorage`、`sessionStorage`、`cookie`



**浏览器缓存全过程**

- 浏览器第一次加载资源服务器返回200，浏览器从服务端下载资源文件并缓存资源文件与响应头信息，以供下次加载时对比使用。
- 下一次加载资源时会先判断能否采取强缓存，先比较当前时间和上一次返回200时的时间，如果没有超过cache-control的max-age则说明缓存没有过期，可以采取强缓存直接从本地读取资源。如果浏览器不支持HTTP1.1可以使用expires头判断是否过期。（cache-control是HTTP1.1新引入的响应头）
- 如果资源过期了则强缓存失效开始协商缓存，向服务器发送带有`If-None-Match`和`If-Modified-Since`的请求。

[^If-None-Match]: 携带上一次服务器返回的ETag（资源唯一标识）
[^If-Modified-Since]: 携带上一次资源最后修改时间

- 服务器收到请求后，优先根据ETag的值判断资源有没有被修改，ETag值一致则没有被修改命中协商缓存，返回 304；如果不一致则有改动，直接返回新的资源带上新的ETag，返回 200。
- 如果服务器收到的请求没有ETag则将`If-Modified-Since`和最后修改时间做对比，如果一致则命中协商缓存返回304；否则返回新的`last-modified`并返回200。

![](C:\Users\WJ\Pictures\浏览器缓存流程图.png)

#### 协商缓存和强缓存区别

1. **强缓存**

强缓存的优先级高于协商缓存。

使用强缓存时，如果缓存资源有效则直接使用缓存资源，不需要向服务端请求。

强缓存策略可以通过两种方式来设置，分别是头信息中的`Expires`属性和`Cache-Control`属性：

**（1）Expires**

这是HTTP1.0中的方式，来指定资源的过期时间，但这个时间是一个绝对时间，是服务器的时间，所以会存在服务器时间和客户端时间不一样的情况。

**（2）Cache-Control**

HTTP1.1则推出了Cache-Control来控制资源的缓存。常见的字段有：

- `max-age`：表示缓存的最大有效期，单位为秒。
- `no-cache`：表示要向服务端确认资源是否发生变化，即只有协商缓存没有强缓存。
- `no-store`：表示不允许缓存，每次都必须向服务端发起请求拉去最新资源。

一般只需要二者选其一来表示强缓存即可，如果两个都使用了Cache-Control的优先级更高。



2. **协商缓存**

只有在有缓存标识且缓存未过期的情况下能命中强缓存，如果未命中且设置了协商缓存则协商缓存发挥作用。

同理协商缓存也可以通过头信息的属性来设置，分别是`ETag`和`Last-Modified`。

**（1）`Last-Modified`**

表示资源最后一次修改的时间。当浏览器再次发起请求时请求头会携带`If-Modified-Since`属性，属性值为上一次资源返回时的`Last-Modified`的值，比较这两个值，如果相等说明资源未被修改，返回304，让客户端使用本地缓存。

但这个属性值只能精确到秒级，如果在一秒内多次修改则无法捕捉到。

**（2）`ETag`**

为解决上述漏洞故推出了`ETag`属性。当服务器返回资源时会在响应头带上ETag属性，属性值是一个唯一的标识符，每当资源被修改ETag属性值也会改变。当客服端再次发起请求时会在请求头携带`If-None-Match`属性，值为上一次资源返回时的`ETag`值，服务器通过比较该值与当前`ETag`值是否相同判断资源有没有被改变，没有改变则返回304让客户端使用本地缓存。



**总结**

强缓存和协商缓存都是命中时直接使用本地缓存资源未命中则向服务器发请求获取最新资源，区别在于协商缓存会向服务器发送一次请求以判断资源是否有更新。在强缓存和协商缓存相关字段都有的前提下，会先判断是否命中强缓存，若不命中则使用协商缓存。



